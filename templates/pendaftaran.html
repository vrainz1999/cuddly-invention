{% extends 'index.html' %}

{% block sidebar %}
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Kelola Pendaftaran</h1>
</div>

<div id="Loader" style="display: none;">
  <div class="d-flex justify-content-center">
    <div class="spinner-border text-danger" style="width: 10rem; height: 10rem" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>

<div class="container">
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">+Tambah Pasien</button>

  <!-- Modal for adding patient -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Pasien Baru</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form class="row g-3 needs-validation" action="{{ url_for('tambahdaftar') }}" id="Daftar" method="POST" novalidate>
            <!-- Add form fields here -->
            <div class="col-md-4">
              <label for="validationCustom01" class="form-label">Name</label>
              <input type="text" class="form-control" id="validationCustom01" name="nama" required>
              <div class="valid-feedback">
                Looks good!
              </div>
            </div>
            <div class="col-md-4">
              <label for="validationCustom02" class="form-label">Tempat</label>
              <input type="text" class="form-control" id="validationCustom02" name="tl" required>
              <div class="valid-feedback">
                Looks good!
              </div>
            </div>
            <div class="col-md-4">
              <label for="validationCustomUsername" class="form-label">Tanggal Lahir</label>
              <div class="input-group has-validation">
                <span class="input-group-text" id="inputGroupPrepend">@</span>
                <input type="date" class="form-control" id="validationCustomUsername" name="tg_lahir" aria-describedby="inputGroupPrepend" required>
              </div>
            </div>
            <div class="col-md-4">
              <label for="validationCustom04" class="form-label">Jenis Kelamin</label>
              <select class="form-select" id="validationCustom04" name="jk" required>
                <option selected disabled value="">Pilih...</option>
                <option value="Laki-Laki">Laki-Laki</option>
                <option value="Perempuan">Perempuan</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="validationCustom03" class="form-label">Status Pernikahan</label>
              <select class="form-select" id="validationCustom03" name="status" required>
                <option selected disabled value="">Pilih...</option>
                <option value="Belum Menikah">Belum Menikah</option>
                <option value="Sudah Menikah">Sudah Menikah</option>
                <option value="Bercerai">Bercerai</option>              
              </select>              
            </div>
            <div class="col-md-4">
              <label for="validationCustom05" class="form-label">Profesi</label>
              <input type="text" class="form-control" name="profesi" id="validationCustom05" required>
              <div class="invalid-feedback">
                Please provide a valid zip.
              </div>
            </div>
            <div class="mb-3">
              <label for="message-text" class="col-form-label">Alamat:</label>
              <textarea class="form-control" name="alamat" style="height: 180px;" id="message-text"></textarea>
            </div>
            <input type="hidden" name="keterangan" value="Diproses">            
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
              <button type="submit" class="btn btn-primary">Tambah</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <br /><br />

  <div class="card">
    <div class="card-header">
      Table Pasien
    </div>
    <div class="card-body">
      <table class="table table-bordered table-sm">
        <thead class="table table-dark">
          <tr>
            <th scope="col">No</th>
            <th scope="col">Nama</th>
            <th scope="col">Tempat Lahir</th>
            <th scope="col">Tanggal Lahir</th>
            <th scope="col">Jenis Kelamin</th>
            <th scope="col">Status</th>
            <th scope="col">Profesi</th>
            <th scope="col">Alamat</th>
            <th scope="col">Keterangan</th>
            <th scope="col">Aksi</th>
          </tr>
        </thead>
        <tbody>
          {% if data %}
            {% for dt in data %}
            <tr>
              <th scope="row">{{ loop.index }}</th>
              <td>{{ dt.nama }}</td>
              <td>{{ dt.tl }}</td>
              <td>{{ dt.tg_lahir }}</td>
              <td>{{ dt.jk }}</td>
              <td>{{ dt.status }}</td>
              <td>{{ dt.profesi }}</td>
              <td>{{ dt.alamat }}</td>
              <td>{{ dt.keterangan }}</td>
              <td>
                <!-- Edit Button -->
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal1{{ dt.id }}">Edit</button>

                <!-- Edit Modal -->
                <div class="modal fade" id="exampleModal1{{ dt.id }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Edit Pasien</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <form class="row g-3 needs-validation" action="{{ url_for('editdaftar', id=dt.id) }}" id="editDaftar{{ dt.id }}" method="POST" novalidate>
                          <!-- Form fields for editing data -->
                          <div class="col-md-4">
                            <label for="editValidationCustom01{{ dt.id }}" class="form-label">Name</label>
                            <input type="text" class="form-control" id="editValidationCustom01{{ dt.id }}" name="nama" value="{{ dt.nama }}" required>
                          </div>
                          <div class="col-md-4">
                            <label for="editValidationCustom02{{ dt.id }}" class="form-label">Tempat</label>
                            <input type="text" class="form-control" id="editValidationCustom02{{ dt.id }}" name="tl" value="{{ dt.tl }}" required>
                          </div>
                          <div class="col-md-4">
                            <label for="editValidationCustomUsername{{ dt.id }}" class="form-label">Tanggal Lahir</label>
                            <div class="input-group has-validation">
                              <span class="input-group-text" id="editInputGroupPrepend{{ dt.id }}">@</span>
                              <input type="date" class="form-control" id="editValidationCustomUsername{{ dt.id }}" name="tg_lahir" value="{{ dt.tg_lahir }}" aria-describedby="editInputGroupPrepend{{ dt.id }}" required>
                            </div>
                          </div>
                          <div class="col-md-4">
                            <label for="editValidationCustom04{{ dt.id }}" class="form-label">Jenis Kelamin</label>
                            <select class="form-select" id="editValidationCustom04{{ dt.id }}" name="jk" required>
                              <option value="Laki-Laki" {% if dt.jk == 'Laki-Laki' %}selected{% endif %}>Laki-Laki</option>
                              <option value="Perempuan" {% if dt.jk == 'Perempuan' %}selected{% endif %}>Perempuan</option>
                            </select>
                          </div>
                          <div class="col-md-4">
                            <label for="editValidationCustom03{{ dt.id }}" class="form-label">Status Pernikahan</label>
                            <select class="form-select" id="editValidationCustom03{{ dt.id }}" name="status" required>
                              <option value="Belum Menikah" {% if dt.status == 'Belum Menikah' %}selected{% endif %}>Belum Menikah</option>
                              <option value="Sudah Menikah" {% if dt.status == 'Sudah Menikah' %}selected{% endif %}>Sudah Menikah</option>
                              <option value="Bercerai" {% if dt.status == 'Bercerai' %}selected{% endif %}>Bercerai</option>
                            </select>              
                          </div>
                          <div class="col-md-4">
                            <label for="editValidationCustom05{{ dt.id }}" class="form-label">Profesi</label>
                            <input type="text" class="form-control" name="profesi" id="editValidationCustom05{{ dt.id }}" value="{{ dt.profesi }}" required>
                          </div>
                          <div class="mb-3">
                            <label for="editMessageText{{ dt.id }}" class="col-form-label">Alamat:</label>
                            <textarea class="form-control" name="alamat" style="height: 180px;" id="editMessageText{{ dt.id }}">{{ dt.alamat }}</textarea>
                          </div>
                          <input type="hidden" name="keterangan" value="Diproses">                            
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                            <button type="submit" class="btn btn-primary">Update</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Delete Button -->
                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#exampleModal2{{ dt.id }}">Hapus</button>

                <!-- Delete Modal -->
                <div class="modal fade" id="exampleModal2{{ dt.id }}" tabindex="-1" aria-labelledby="exampleModalLabel2" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title fs-5" id="exampleModalLabel2">Konfirmasi</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <h5>Apakah anda ingin menghapus data ini?</h5>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <a href="/hapusdaftar/{{ dt.id }}" class="btn btn-danger">Ya, Hapus</a>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="10">Tidak ada data pasien</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% block tail %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelector('#Daftar').onsubmit = async (e) => {
      e.preventDefault();
      const req = new XMLHttpRequest();
      req.onload = () => {
        console.log(req.responseText); // Debugging
        try {
          const data = JSON.parse(req.responseText);
          if (data.success) {
            alert("Data berhasil ditambahkan!");
            location.reload();
          } else {
            alert("Ada trouble");
          }
        } catch (error) {
          console.error("Parsing error:", error);
        }
      };
      req.onerror = () => {
        alert("Request error");
      };
      const form = document.querySelector("#Daftar");
      const datanya = new FormData(form);
      req.open("POST", "{{ url_for('tambahdaftar') }}", true);
      req.send(datanya);
    };
  
    {% for dt in data %}
    document.querySelector(`#editDaftar{{ dt.id }}`).onsubmit = async (e) => {
      e.preventDefault();
      const req = new XMLHttpRequest();
      req.onload = () => {
        console.log("Response Data for edit:", req.responseText); // Debugging output
        const data = JSON.parse(req.responseText);
        if (data.success) {
          alert("Data berhasil diupdate!");
          location.reload();
        } else {
          alert("Ada trouble");
        }
      };
      req.onerror = () => {
        alert("Request error");
      };
      const form = document.querySelector(`#editDaftar{{ dt.id }}`);
      const datanya = new FormData(form);
      console.log("Sending data for edit:", datanya); // Debugging output
      req.open("POST", "{{ url_for('editdaftar', id=dt.id) }}", true);
      req.send(datanya);
    };
    {% endfor %}
  
    // Add an event listener for delete buttons
    document.querySelectorAll('[data-bs-target^="#exampleModal2"]').forEach(button => {
      button.addEventListener('click', () => {
        const url = button.getAttribute('data-href');
        document.querySelector('#exampleModal2 .btn-danger').setAttribute('href', url);
      });
    });
  });
  </script>
{% endblock %}
{% endblock %}